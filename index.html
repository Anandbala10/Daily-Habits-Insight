<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Habits Tracker Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            font-weight: 600;
            color: #6b7280;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-8 md:p-12">
    <div class="max-w-7xl mx-auto">
        <!-- Dashboard Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Daily Habits Tracker Analysis</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Upload your habits data to get a personalized, data-driven analysis and actionable insights.
            </p>
        </header>

        <!-- File Upload Section -->
        <div class="card mb-8 text-center">
            <h2 class="section-title">Upload Your Data</h2>
            <p class="text-gray-500 mb-4">Please upload a CSV file with the following columns: Date, SleepHours, StudyHours, ScreenTime(hrs), Exercise(mins), Mood(1-5).</p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="file" id="csvFile" accept=".csv" class="rounded-md border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="processCSV()" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    Analyze Data
                </button>
            </div>
            <p id="statusMessage" class="mt-4 text-sm font-medium text-gray-500"></p>
        </div>

        <!-- Main Content Grid -->
        <main id="dashboardContent" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">

            <!-- Correlations Section -->
            <div class="lg:col-span-2 card">
                <h2 class="section-title">Habit Correlations</h2>
                <p class="text-gray-500 mb-4">This chart shows how different habits are correlated with your daily mood.</p>
                <div class="relative h-96">
                    <canvas id="correlationChart"></canvas>
                </div>
                <div class="mt-8 text-sm text-gray-500">
                    <p><strong>Note:</strong> Positive correlation values (closer to +1) mean a habit is associated with a better mood, while negative values (closer to -1) mean it is associated with a lower mood.</p>
                </div>
            </div>

            <!-- Key Insights Summary -->
            <div class="card">
                <h2 class="section-title">Key Insights & Actions</h2>
                <div id="insightsList">
                    <p class="text-gray-500">Analysis will appear here after data upload.</p>
                </div>
            </div>

            <!-- Weekly Patterns Section -->
            <div class="lg:col-span-3 card">
                <h2 class="section-title">Weekly & Weekend Patterns</h2>
                <p class="text-gray-500 mb-4">See how your habits and mood change on different days of the week.</p>
                <div class="overflow-x-auto">
                    <table class="data-table w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2">Day</th>
                                <th>Sleep (hrs)</th>
                                <th>Study (hrs)</th>
                                <th>Screen Time (hrs)</th>
                                <th>Exercise (min)</th>
                                <th>Mood (1-5)</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyTableBody" class="text-gray-700">
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="weekendMood" class="mt-6 text-gray-600"></div>
            </div>

            <!-- Mood Trend Chart -->
            <div class="lg:col-span-3 card">
                <h2 class="section-title">Mood Trend Over Time</h2>
                <p class="text-gray-500 mb-4">Track your mood's daily and 7-day average trends to spot long-term patterns.</p>
                <div class="relative h-96">
                    <canvas id="moodTrendChart"></canvas>
                </div>
            </div>

        </main>
    </div>
    
    <script>
        let correlationChart;
        let moodTrendChart;

        async function processCSV() {
            const fileInput = document.getElementById('csvFile');
            const statusMessage = document.getElementById('statusMessage');
            const dashboardContent = document.getElementById('dashboardContent');

            if (fileInput.files.length === 0) {
                statusMessage.textContent = "Please select a CSV file to upload.";
                statusMessage.style.color = '#dc2626';
                return;
            }

            statusMessage.textContent = "Processing data...";
            statusMessage.style.color = '#2563eb';
            dashboardContent.classList.add('hidden');

            const file = fileInput.files[0];
            
            try {
                const data = await parseCSV(file);
                const df = preprocessData(data);
                if (df.length === 0) {
                    throw new Error("CSV file is empty or has no valid data.");
                }
                
                const correlations = calculateCorrelations(df);
                const weeklyPatterns = calculateWeeklyPatterns(df);
                const weekendComparison = calculateWeekendComparison(df);
                const insights = generateInsights(df, correlations, weekendComparison);
                
                renderCorrelationsChart(correlations);
                renderWeeklyTable(weeklyPatterns);
                renderInsights(insights, weekendComparison);
                renderMoodTrendChart(df);

                dashboardContent.classList.remove('hidden');
                statusMessage.textContent = "Analysis complete! ðŸŽ‰";
                statusMessage.style.color = '#10b981';
            } catch (error) {
                console.error("Error processing data:", error);
                statusMessage.textContent = `Error: ${error.message}. Please check your file format.`;
                statusMessage.style.color = '#dc2626';
            }
        }

        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            reject(new Error(results.errors[0].message));
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: (error) => reject(error)
                });
            });
        }

        function preprocessData(data) {
            return data.map(row => {
                const dateStr = row.Date.split(' ')[0]; // Take only the date part
                const date = new Date(dateStr);
                
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
                const weekNumber = getWeekNumber(date);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                const sleepHours = parseFloat(row.SleepHours);
                const studyHours = parseFloat(row.StudyHours);
                const screenTime = parseFloat(row['ScreenTime(hrs)']);
                const exerciseMins = parseFloat(row['Exercise(mins)']);
                const mood = parseFloat(row['Mood(1-5)']);

                // Ensure data is valid before calculating
                if (isNaN(date.getTime()) || isNaN(sleepHours) || isNaN(studyHours) || isNaN(screenTime) || isNaN(exerciseMins) || isNaN(mood)) {
                    console.warn("Skipping invalid row:", row);
                    return null;
                }
                
                const productivityScore = (studyHours + (exerciseMins / 60)) - screenTime;
                const sleepQuality = sleepHours >= 7 ? "Good" : "Poor";
                
                return {
                    ...row,
                    Date: date,
                    DayOfWeek: dayOfWeek,
                    WeekNumber: weekNumber,
                    IsWeekend: isWeekend,
                    SleepHours: sleepHours,
                    StudyHours: studyHours,
                    'ScreenTime(hrs)': screenTime,
                    'Exercise(mins)': exerciseMins,
                    'Mood(1-5)': mood,
                    ProductivityScore: productivityScore,
                    SleepQuality: sleepQuality
                };
            }).filter(row => row !== null);
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function pearsonCorrelation(x, y) {
            let n = x.length;
            let sum_x = 0;
            let sum_y = 0;
            let sum_xy = 0;
            let sum_x2 = 0;
            let sum_y2 = 0;

            for (let i = 0; i < n; i++) {
                sum_x += x[i];
                sum_y += y[i];
                sum_xy += x[i] * y[i];
                sum_x2 += x[i] * x[i];
                sum_y2 += y[i] * y[i];
            }

            let numerator = (n * sum_xy) - (sum_x * sum_y);
            let denominator = Math.sqrt(((n * sum_x2) - (sum_x * sum_x)) * ((n * sum_y2) - (sum_y * sum_y)));

            return numerator / denominator;
        }

        function calculateCorrelations(df) {
            const keyCorrelations = [
                { col1: 'SleepHours', col2: 'Mood(1-5)' },
                { col1: 'StudyHours', col2: 'Mood(1-5)' },
                { col1: 'ScreenTime(hrs)', col2: 'SleepHours' },
                { col1: 'Exercise(mins)', col2: 'Mood(1-5)' },
                { col1: 'ProductivityScore', col2: 'Mood(1-5)' }
            ];

            return keyCorrelations.map(corr => {
                const values1 = df.map(row => row[corr.col1]);
                const values2 = df.map(row => row[corr.col2]);
                const correlation = pearsonCorrelation(values1, values2);
                return { label: `${corr.col1} vs ${corr.col2}`, corr: correlation };
            });
        }
        
        function calculateWeeklyPatterns(df) {
            const dayOrder = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const patterns = {};
            dayOrder.forEach(day => {
                const dayData = df.filter(row => row.DayOfWeek === day);
                if (dayData.length > 0) {
                    const avg = {
                        SleepHours: dayData.reduce((sum, row) => sum + row.SleepHours, 0) / dayData.length,
                        StudyHours: dayData.reduce((sum, row) => sum + row.StudyHours, 0) / dayData.length,
                        'ScreenTime(hrs)': dayData.reduce((sum, row) => sum + row['ScreenTime(hrs)'], 0) / dayData.length,
                        'Exercise(mins)': dayData.reduce((sum, row) => sum + row['Exercise(mins)'], 0) / dayData.length,
                        'Mood(1-5)': dayData.reduce((sum, row) => sum + row['Mood(1-5)'], 0) / dayData.length
                    };
                    patterns[day] = avg;
                }
            });
            return patterns;
        }
        
        function calculateWeekendComparison(df) {
            const weekdayMoods = df.filter(row => !row.IsWeekend).map(row => row['Mood(1-5)']);
            const weekendMoods = df.filter(row => row.IsWeekend).map(row => row['Mood(1-5)']);
            const weekdayAvg = weekdayMoods.reduce((sum, val) => sum + val, 0) / weekdayMoods.length;
            const weekendAvg = weekendMoods.reduce((sum, val) => sum + val, 0) / weekendMoods.length;
            
            return {
                weekdayMood: weekdayAvg,
                weekendMood: weekendAvg
            };
        }

        function generateInsights(df, correlations, weekendComparison) {
            const insights = [];
            
            const topPositive = correlations.sort((a, b) => b.corr - a.corr)[0];
            const topNegative = correlations.sort((a, b) => a.corr - b.corr)[0];
            
            insights.push(`The strongest positive relationship is between <strong>${topPositive.label.replace(' vs Mood(1-5)', '')}</strong> and your mood. Focusing on this habit could improve your overall mood.`);
            
            if (topNegative.corr < 0) {
                insights.push(`The strongest negative relationship is between <strong>${topNegative.label.replace(' vs Mood(1-5)', '')}</strong> and your mood. Reducing or managing this habit could lead to a better mood.`);
            }

            // Using a simple median approximation instead of jstat.quartiles
            const moodValues = df.map(row => row['Mood(1-5)']).sort((a, b) => a - b);
            const topQuartileMood = moodValues[Math.floor(moodValues.length * 0.75)];
            const highMoodDays = df.filter(row => row['Mood(1-5)'] >= topQuartileMood);

            if (highMoodDays.length > 0) {
                const avgSleep = highMoodDays.reduce((sum, row) => sum + row.SleepHours, 0) / highMoodDays.length;
                const avgExercise = highMoodDays.reduce((sum, row) => sum + row['Exercise(mins)'], 0) / highMoodDays.length;
                insights.push(`On your best days, you averaged <strong>${avgSleep.toFixed(1)} hours of sleep</strong> and <strong>${avgExercise.toFixed(0)} minutes of exercise</strong>. Aiming for these targets could boost your mood.`);
            }

            if (weekendComparison.weekendMood > weekendComparison.weekdayMood) {
                insights.push(`You tend to be happier on weekends! Consider how you can bring some of your weekend habits into your weekdays.`);
            } else {
                insights.push(`You tend to maintain a more consistent mood on weekdays. Try to maintain this structure and routine on weekends.`);
            }

            return insights;
        }

        function renderCorrelationsChart(correlations) {
            if (correlationChart) correlationChart.destroy();
            
            const labels = correlations.map(c => c.label.replace(' vs Mood(1-5)', ''));
            const data = correlations.map(c => c.corr);
            const colors = data.map(val => val > 0 ? '#2563eb' : '#ef4444');

            const ctx1 = document.getElementById('correlationChart').getContext('2d');
            correlationChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Correlation with Mood',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            max: 1,
                            min: -1
                        }
                    }
                }
            });
        }
        
        function renderWeeklyTable(weeklyData) {
            const tableBody = document.getElementById('weeklyTableBody');
            tableBody.innerHTML = '';
            
            const dayOrder = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            dayOrder.forEach(day => {
                const data = weeklyData[day];
                if (data) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-semibold">${day}</td>
                        <td>${data.SleepHours ? data.SleepHours.toFixed(2) : 'N/A'}</td>
                        <td>${data.StudyHours ? data.StudyHours.toFixed(2) : 'N/A'}</td>
                        <td>${data['ScreenTime(hrs)'] ? data['ScreenTime(hrs)'].toFixed(2) : 'N/A'}</td>
                        <td>${data['Exercise(mins)'] ? data['Exercise(mins)'].toFixed(0) : 'N/A'}</td>
                        <td>${data['Mood(1-5)'] ? data['Mood(1-5)'].toFixed(2) : 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        }
        
        function renderInsights(insights, weekendComparison) {
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = `<ul class="list-disc list-inside space-y-3 text-gray-700"></ul>`;
            const list = insightsList.querySelector('ul');
            
            insights.forEach(insight => {
                const listItem = document.createElement('li');
                listItem.innerHTML = insight;
                list.appendChild(listItem);
            });
            
            const moodText = `Your average mood is <strong>${weekendComparison.weekdayMood.toFixed(2)}</strong> on weekdays and <strong>${weekendComparison.weekendMood.toFixed(2)}</strong> on weekends.`;
            document.getElementById('weekendMood').innerHTML = moodText;
        }

        function renderMoodTrendChart(df) {
            if (moodTrendChart) moodTrendChart.destroy();

            const dates = df.map(row => row.Date.toLocaleDateString());
            const moods = df.map(row => row['Mood(1-5)']);

            const rollingAverage = (arr, window) => {
                const result = [];
                for (let i = 0; i < arr.length; i++) {
                    const start = Math.max(0, i - Math.floor(window / 2));
                    const end = Math.min(arr.length, i + Math.ceil(window / 2));
                    const slice = arr.slice(start, end);
                    const sum = slice.reduce((a, b) => a + b, 0);
                    result.push(sum / slice.length);
                }
                return result;
            };

            const rollingMoods = rollingAverage(moods, 7);

            const ctx2 = document.getElementById('moodTrendChart').getContext('2d');
            moodTrendChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Mood',
                            data: moods,
                            borderColor: '#9ca3af',
                            backgroundColor: 'transparent',
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            borderWidth: 1,
                            tension: 0.4
                        },
                        {
                            label: '7-Day Average Mood',
                            data: rollingMoods,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            pointRadius: 0,
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 1,
                            max: 5
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
